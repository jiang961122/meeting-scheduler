import streamlit as st
import pandas as pd
from datetime import datetime, timedelta

# --- 1. è¨­å®šé é¢ ---
st.set_page_config(page_title="æœƒè­°æ™‚é–“çµ±æ•´å¤§å¸«", layout="centered")

# --- 2. æ¨¡æ“¬è³‡æ–™åº« (åœ¨å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰é€£æ¥ SQL æˆ– Firebase) ---
if 'event_data' not in st.session_state:
    st.session_state.event_data = {
        'title': '',
        'slots': [],
        'votes': {}  # æ ¼å¼: {'Amy': [True, False], 'Bob': [True, True]}
    }

# --- 3. ä»‹é¢é‚è¼¯ ---

st.title("ğŸ“… æœƒè­°æ™‚é–“çµ±æ•´å°å¹«æ‰‹")

# åˆ†é ï¼šå»ºç«‹æœƒè­° vs åƒèˆ‡æŠ•ç¥¨
tab1, tab2, tab3 = st.tabs(["æˆ‘æ˜¯ä¸»è¾¦äºº (å»ºç«‹)", "æˆ‘æ˜¯åƒèˆ‡è€… (æŠ•ç¥¨)", "æŸ¥çœ‹çµæœ"])

# === Tab 1: ä¸»è¾¦äººå»ºç«‹æœƒè­° ===
with tab1:
    st.header("å»ºç«‹æ–°æœƒè­°")
    title = st.text_input("æœƒè­°åç¨±", placeholder="ä¾‹å¦‚ï¼šQ1 ç”¢å“è¦åŠƒæœƒè­°")
    
    # é¸æ“‡æ—¥æœŸèˆ‡æ™‚æ®µ
    col1, col2 = st.columns(2)
    with col1:
        date = st.date_input("é¸æ“‡æ—¥æœŸ", min_value=datetime.today())
    with col2:
        times = st.multiselect("é¸æ“‡å»ºè­°æ™‚æ®µ", 
                               ["09:00", "10:00", "11:00", "13:00", "14:00", "15:00", "16:00", "17:00"])
    
    if st.button("ç”Ÿæˆæœƒè­°"):
        if title and times:
            # æ¸…ç©ºèˆŠè³‡æ–™ä¸¦å„²å­˜æ–°è³‡æ–™
            st.session_state.event_data['title'] = title
            # å»ºç«‹æ™‚æ®µæ¨™ç±¤ (Date + Time)
            slots = [f"{date} {t}" for t in times]
            st.session_state.event_data['slots'] = slots
            st.session_state.event_data['votes'] = {} # é‡ç½®æŠ•ç¥¨
            st.success(f"æœƒè­°ã€Œ{title}ã€å·²å»ºç«‹ï¼è«‹åˆ‡æ›åˆ°ã€ŒæŠ•ç¥¨ã€åˆ†é æ¸¬è©¦ã€‚")
        else:
            st.error("è«‹è¼¸å…¥åç¨±ä¸¦è‡³å°‘é¸æ“‡ä¸€å€‹æ™‚æ®µã€‚")

# === Tab 2: åƒèˆ‡è€…æŠ•ç¥¨ ===
with tab2:
    st.header("å¡«å¯«æœ‰ç©ºçš„æ™‚é–“")
    
    current_title = st.session_state.event_data['title']
    current_slots = st.session_state.event_data['slots']
    
    if not current_title:
        st.warning("ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æœƒè­°èª¿æŸ¥ã€‚")
    else:
        st.subheader(f"æœƒè­°ï¼š{current_title}")
        voter_name = st.text_input("æ‚¨çš„å§“å")
        
        st.write("è«‹å‹¾é¸æ‚¨æœ‰ç©ºçš„æ™‚é–“ï¼š")
        
        # å»ºç«‹è¡¨å–®ä¾†æ”¶é›†å‹¾é¸ç‹€æ…‹
        with st.form("voting_form"):
            selections = []
            for slot in current_slots:
                # é è¨­ä¸å‹¾é¸
                is_selected = st.checkbox(slot, key=slot)
                selections.append(is_selected)
            
            submit = st.form_submit_button("é€å‡ºæŠ•ç¥¨")
            
            if submit and voter_name:
                # å„²å­˜æŠ•ç¥¨çµæœ
                st.session_state.event_data['votes'][voter_name] = selections
                st.success(f"{voter_name}ï¼Œæ‚¨çš„æŠ•ç¥¨å·²è¨˜éŒ„ï¼")
            elif submit and not voter_name:
                st.error("è«‹è¼¸å…¥å§“åã€‚")

# === Tab 3: æŸ¥çœ‹çµ±è¨ˆçµæœ ===
with tab3:
    st.header("çµ±è¨ˆçµæœ")
    
    votes_dict = st.session_state.event_data['votes']
    slots = st.session_state.event_data['slots']
    
    if not votes_dict:
        st.info("å°šç„¡äººæŠ•ç¥¨ã€‚")
    else:
        # å°‡è³‡æ–™è½‰æ›ç‚º DataFrame ä»¥ä¾¿å±•ç¤º
        # è¡Œ(Index)æ˜¯åƒèˆ‡è€…ï¼Œåˆ—(Columns)æ˜¯æ™‚æ®µ
        df = pd.DataFrame(votes_dict, index=slots).T
        
        # å°‡ True/False è½‰ç‚º Emoji æ¯”è¼ƒå¥½è®€
        display_df = df.applymap(lambda x: "âœ… OK" if x else "âŒ")
        
        st.table(display_df)
        
        # çµ±è¨ˆæ¯å€‹æ™‚æ®µçš„ç¸½å¾—ç¥¨æ•¸
        st.subheader("æœ€ä½³æ™‚æ®µæ¨è–¦")
        vote_counts = df.sum(axis=0) # è¨ˆç®—æ¯ä¸€æ¬„(æ™‚æ®µ)æœ‰å¤šå°‘ True
        best_slot = vote_counts.idxmax()
        max_votes = vote_counts.max()
        
        st.success(f"ç›®å‰æœ€ä½³æ™‚æ®µæ˜¯ï¼š **{best_slot}** ({max_votes} äººæœ‰ç©º)")
        
        # é¡¯ç¤ºç›´æ¢åœ–
        st.bar_chart(vote_counts)